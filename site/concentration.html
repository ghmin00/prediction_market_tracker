<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Concentration &amp; Fragility &mdash; PM Intel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: { 800: '#1a1a2e', 900: '#0f0f1a', 700: '#252547' },
                        kalshi: '#f59e0b',
                        poly: '#8b5cf6',
                    }
                }
            }
        }
    </script>
    <style>
        body { background: #0f0f1a; }
        .scrollbar-thin::-webkit-scrollbar { width: 6px; height: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: #1a1a2e; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #252547; border-radius: 3px; }
        .scrollbar-thin::-webkit-scrollbar-thumb:hover { background: #3a3a6a; }
        .treemap-cell {
            position: absolute;
            overflow: hidden;
            cursor: pointer;
            transition: filter 0.2s, box-shadow 0.2s;
            border: 1px solid rgba(0,0,0,0.3);
        }
        .treemap-cell:hover {
            filter: brightness(1.25);
            box-shadow: 0 0 16px rgba(255,255,255,0.12);
            z-index: 10;
        }
        .treemap-cell.active {
            box-shadow: 0 0 0 3px #fff, 0 0 20px rgba(255,255,255,0.2);
            z-index: 20;
        }
        .treemap-label {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 6px;
            text-align: center;
            pointer-events: none;
            text-shadow: 0 1px 4px rgba(0,0,0,0.7);
        }
        .subcell {
            position: absolute;
            overflow: hidden;
            border: 1px solid rgba(0,0,0,0.25);
            transition: filter 0.15s;
        }
        .subcell:hover {
            filter: brightness(1.3);
        }
        .subcell-label {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3px;
            text-align: center;
            pointer-events: none;
            text-shadow: 0 1px 3px rgba(0,0,0,0.8);
        }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="text-gray-200 min-h-screen">
    <nav class="bg-dark-800 border-b border-gray-700/50 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-3 flex items-center gap-6 overflow-x-auto">
            <a href="index.html" class="text-lg font-bold text-white whitespace-nowrap" data-i18n="nav.home">PM Intel</a>
            <a href="platform-war.html" class="text-sm text-gray-400 hover:text-kalshi whitespace-nowrap" data-i18n="nav.platform-war">Platform War</a>
            <a href="arbitrage.html" class="text-sm text-gray-400 hover:text-poly whitespace-nowrap" data-i18n="nav.arbitrage">Arbitrage Map</a>
            <a href="wash-trading.html" class="text-sm text-gray-400 hover:text-red-400 whitespace-nowrap" data-i18n="nav.wash-trading">Wash Trading</a>
            <a href="election.html" class="text-sm text-gray-400 hover:text-blue-400 whitespace-nowrap" data-i18n="nav.election">Election Impact</a>
            <a href="concentration.html" class="text-sm text-white font-semibold whitespace-nowrap" data-i18n="nav.concentration">Concentration</a>
            <a href="timelapse.html" class="text-sm text-gray-400 hover:text-emerald-400 whitespace-nowrap" data-i18n="nav.timelapse">Time Lapse</a>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 py-10">

        <!-- Header -->
        <div class="mb-10">
            <h1 class="text-4xl font-bold text-white mb-3" data-i18n="con.title">Concentration &amp; Fragility</h1>
            <p class="text-gray-400 max-w-3xl text-base leading-relaxed" data-i18n-html="con.subtitle">
                Prediction markets are overwhelmingly <span class="text-green-400 font-semibold">sports betting</span>.
                More than half of all volume across Kalshi and Polymarket flows into a handful of sports subcategories.
                This extreme concentration creates fragility: a single regulatory action against sports betting
                could wipe out the majority of market activity overnight.
            </p>
        </div>

        <!-- Callout Insights -->
        <div class="grid md:grid-cols-3 gap-4 mb-10">
            <div class="bg-dark-800 rounded-xl p-5 border border-green-500/30">
                <div class="text-3xl font-bold text-green-400 mb-1">52%</div>
                <div class="text-sm text-gray-400" data-i18n="con.s1">of all volume is sports betting</div>
                <div class="text-xs text-gray-500 mt-1" data-i18n="con.s1.sub">$49.1B of $87.1B total</div>
            </div>
            <div class="bg-dark-800 rounded-xl p-5 border border-yellow-500/30">
                <div class="text-3xl font-bold text-yellow-400 mb-1">63%</div>
                <div class="text-sm text-gray-400" data-i18n="con.s2">controlled by top 5 subcategories</div>
                <div class="text-xs text-gray-500 mt-1" data-i18n="con.s2.sub">Football, Basketball, US Elections, Soccer, Bitcoin</div>
            </div>
            <div class="bg-dark-800 rounded-xl p-5 border border-red-500/30">
                <div class="text-3xl font-bold text-red-400 mb-1">19.4%</div>
                <div class="text-sm text-gray-400" data-i18n="con.s3">Football alone</div>
                <div class="text-xs text-gray-500 mt-1" data-i18n-html="con.s3.sub">$16.9B &mdash; larger than all of Crypto</div>
            </div>
        </div>

        <!-- Treemap Section -->
        <div class="bg-dark-800 rounded-xl p-6 border border-gray-700/50 mb-8">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h2 class="text-lg font-bold text-white" data-i18n="con.tree.title">Volume Treemap</h2>
                    <p class="text-sm text-gray-400 mt-1" data-i18n="con.tree.desc">Click a category to drill down into subcategories</p>
                </div>
                <button id="treemapResetBtn" class="hidden text-sm bg-dark-700 hover:bg-dark-700/80 text-gray-300 px-3 py-1.5 rounded-lg transition" data-i18n="con.tree.back">
                    &larr; Back to overview
                </button>
            </div>
            <div id="treemapContainer" class="relative w-full rounded-lg overflow-hidden" style="height: 420px; background: #0f0f1a;">
            </div>
        </div>

        <!-- Drill-Down Detail Panel -->
        <div id="drillDownPanel" class="hidden bg-dark-800 rounded-xl p-6 border border-gray-700/50 mb-8 fade-in">
            <div class="flex items-center gap-3 mb-4">
                <div id="drillDot" class="w-4 h-4 rounded-full"></div>
                <h2 id="drillTitle" class="text-lg font-bold text-white"></h2>
                <span id="drillPct" class="text-sm text-gray-400 ml-2"></span>
            </div>
            <div id="drillTreemap" class="relative w-full rounded-lg overflow-hidden mb-6" style="height: 360px; background: #0f0f1a;"></div>
            <div>
                <h3 class="text-sm font-semibold text-gray-400 uppercase tracking-wider mb-3">Subcategories (ranked by volume)</h3>
                <div id="drillTable" class="space-y-2 max-h-[400px] overflow-y-auto scrollbar-thin pr-2"></div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="grid lg:grid-cols-2 gap-6 mb-8">
            <!-- Doughnut Chart -->
            <div class="bg-dark-800 rounded-xl p-6 border border-gray-700/50">
                <h2 class="text-lg font-bold text-white mb-1" data-i18n="con.donut.title">Category Breakdown</h2>
                <p class="text-sm text-gray-400 mb-4" data-i18n="con.donut.desc">Share of total volume by top-level category</p>
                <div class="flex justify-center">
                    <div style="max-width: 360px; width: 100%;">
                        <canvas id="doughnutChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Kalshi vs Poly Concentration -->
            <div class="bg-dark-800 rounded-xl p-6 border border-gray-700/50">
                <h2 class="text-lg font-bold text-white mb-1" data-i18n="con.mix.title">Platform Mix by Category</h2>
                <p class="text-sm text-gray-400 mb-4" data-i18n="con.mix.desc">Kalshi vs Polymarket volume share per category</p>
                <div style="position: relative; height: 320px;">
                    <canvas id="platformMixChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Top 15 Subcategories Bar Chart -->
        <div class="bg-dark-800 rounded-xl p-6 border border-gray-700/50 mb-8">
            <h2 class="text-lg font-bold text-white mb-1" data-i18n="con.top15.title">Top 15 Subcategories</h2>
            <p class="text-sm text-gray-400 mb-4" data-i18n="con.top15.desc">The largest subcategories across all categories, colored by parent</p>
            <div style="position: relative; height: 520px;">
                <canvas id="top15Chart"></canvas>
            </div>
        </div>

        <!-- Bottom Summary -->
        <div class="bg-dark-800 rounded-xl p-8 border border-gray-700/50">
            <h2 class="text-lg font-bold text-white mb-4" data-i18n="con.meaning">What This Means</h2>
            <div class="grid md:grid-cols-2 gap-6 text-sm text-gray-400 leading-relaxed">
                <div>
                    <h3 class="text-white font-semibold mb-2" data-i18n="con.risk.title">Concentration Risk</h3>
                    <p data-i18n="con.risk.desc">
                        When over half of all trading volume flows through sports markets, any disruption to sports betting &mdash;
                        regulatory changes, league lockouts, or seasonal troughs &mdash; directly threatens the viability
                        of the entire prediction market ecosystem. This is not diversification; it is disguised bookmaking.
                    </p>
                </div>
                <div>
                    <h3 class="text-white font-semibold mb-2" data-i18n="con.tail.title">The Long Tail is Tiny</h3>
                    <p data-i18n="con.tail.desc">
                        Categories that arguably represent the "prediction market" ideal &mdash; economics, science, policy forecasting &mdash;
                        together account for less than 7% of volume. The intellectual promise of prediction markets as
                        information aggregation tools remains dwarfed by the reality of sports and crypto speculation.
                    </p>
                </div>
            </div>
        </div>

    </main>

    <script>
    // =========================================================================
    //  CATEGORY COLORS
    // =========================================================================
    const CATEGORY_COLORS = {
        'Sports':     { bg: '#22c55e', bgDark: '#166534', text: '#fff' },
        'Politics':   { bg: '#3b82f6', bgDark: '#1e3a5f', text: '#fff' },
        'Crypto':     { bg: '#f97316', bgDark: '#7c2d12', text: '#fff' },
        'Economics':  { bg: '#14b8a6', bgDark: '#134e4a', text: '#fff' },
        'Culture':    { bg: '#ec4899', bgDark: '#831843', text: '#fff' },
        'STEM':       { bg: '#06b6d4', bgDark: '#164e63', text: '#fff' },
        'Financials': { bg: '#eab308', bgDark: '#713f12', text: '#fff' },
    };

    function getCatColor(name) {
        return CATEGORY_COLORS[name] || { bg: '#6b7280', bgDark: '#374151', text: '#fff' };
    }

    // =========================================================================
    //  SQUARIFIED TREEMAP ALGORITHM
    // =========================================================================
    // Based on Bruls, Huizing, van Wijk "Squarified Treemaps" (2000)
    function squarify(items, rect) {
        if (!items.length) return [];
        const totalValue = items.reduce((s, d) => s + d.value, 0);
        if (totalValue <= 0) return [];

        // Assign area proportional to value
        const totalArea = rect.w * rect.h;
        const mapped = items.map(d => ({
            ...d,
            area: (d.value / totalValue) * totalArea
        })).filter(d => d.area > 0);

        // Sort descending by area
        mapped.sort((a, b) => b.area - a.area);

        const placed = [];
        layoutStrip(mapped, { x: rect.x, y: rect.y, w: rect.w, h: rect.h }, placed);
        return placed;
    }

    function layoutStrip(items, rect, placed) {
        if (items.length === 0) return;
        if (items.length === 1) {
            placed.push({ ...items[0], x: rect.x, y: rect.y, w: rect.w, h: rect.h });
            return;
        }

        const totalArea = items.reduce((s, d) => s + d.area, 0);
        const isWide = rect.w >= rect.h;
        const side = isWide ? rect.h : rect.w;

        let strip = [items[0]];
        let stripArea = items[0].area;
        let bestWorst = worstRatio(strip, stripArea, side);

        for (let i = 1; i < items.length; i++) {
            const candidate = [...strip, items[i]];
            const candidateArea = stripArea + items[i].area;
            const candidateWorst = worstRatio(candidate, candidateArea, side);

            if (candidateWorst <= bestWorst) {
                strip.push(items[i]);
                stripArea = candidateArea;
                bestWorst = candidateWorst;
            } else {
                break;
            }
        }

        // Lay out the strip
        const stripLen = stripArea / side;
        let offset = 0;

        for (const item of strip) {
            const itemLen = item.area / stripLen;
            if (isWide) {
                placed.push({ ...item, x: rect.x, y: rect.y + offset, w: stripLen, h: itemLen });
            } else {
                placed.push({ ...item, x: rect.x + offset, y: rect.y, w: itemLen, h: stripLen });
            }
            offset += itemLen;
        }

        // Remaining area
        const remaining = items.slice(strip.length);
        if (remaining.length === 0) return;

        // Recalculate remaining areas proportionally
        const remainingTotalArea = totalArea - stripArea;
        let newRect;
        if (isWide) {
            newRect = { x: rect.x + stripLen, y: rect.y, w: rect.w - stripLen, h: rect.h };
        } else {
            newRect = { x: rect.x, y: rect.y + stripLen, w: rect.w, h: rect.h - stripLen };
        }

        layoutStrip(remaining, newRect, placed);
    }

    function worstRatio(strip, stripArea, side) {
        const s2 = side * side;
        const totalA2 = stripArea * stripArea;
        let worst = 0;
        for (const item of strip) {
            const r1 = (s2 * item.area) / totalA2;
            const r2 = totalA2 / (s2 * item.area);
            worst = Math.max(worst, Math.max(r1, r2));
        }
        return worst;
    }

    // =========================================================================
    //  FORMATTING HELPERS
    // =========================================================================
    function fmtBillions(v) {
        if (v >= 1e9) return '$' + (v / 1e9).toFixed(1) + 'B';
        if (v >= 1e6) return '$' + (v / 1e6).toFixed(0) + 'M';
        if (v >= 1e3) return '$' + (v / 1e3).toFixed(0) + 'K';
        return '$' + v;
    }

    // =========================================================================
    //  RENDER TREEMAP INTO A CONTAINER
    // =========================================================================
    function renderTreemap(container, items, colorFn, onClick) {
        container.innerHTML = '';
        const rect = {
            x: 0, y: 0,
            w: container.clientWidth,
            h: container.clientHeight
        };

        const cells = squarify(items, rect);

        cells.forEach((cell, i) => {
            const col = colorFn(cell);
            const div = document.createElement('div');
            div.className = 'treemap-cell';
            div.style.left = cell.x + 'px';
            div.style.top = cell.y + 'px';
            div.style.width = cell.w + 'px';
            div.style.height = cell.h + 'px';
            div.style.background = `linear-gradient(135deg, ${col.bg}, ${col.bgDark})`;
            div.dataset.index = i;
            div.dataset.name = cell.name;

            // Label sizing based on cell area
            const area = cell.w * cell.h;
            const minDim = Math.min(cell.w, cell.h);

            const label = document.createElement('div');
            label.className = 'treemap-label';

            if (minDim > 50 && area > 3000) {
                const nameSize = Math.max(10, Math.min(20, minDim / 6));
                const pctSize = Math.max(9, Math.min(16, minDim / 8));
                label.innerHTML = `
                    <span style="font-size:${nameSize}px; font-weight:700; color:${col.text}; line-height:1.2;">${cell.name}</span>
                    <span style="font-size:${pctSize}px; color:rgba(255,255,255,0.8); margin-top:2px;">${cell.pct}%</span>
                `;
            } else if (minDim > 30 && area > 1200) {
                label.innerHTML = `
                    <span style="font-size:10px; font-weight:600; color:${col.text}; line-height:1.1;">${cell.name}</span>
                `;
            }

            div.appendChild(label);

            if (onClick) {
                div.addEventListener('click', () => onClick(cell, div));
            }

            // Tooltip
            div.title = `${cell.name}: ${cell.pct}% (${fmtBillions(cell.value)})`;

            container.appendChild(div);
        });
    }

    // =========================================================================
    //  MAIN: LOAD DATA AND BUILD PAGE
    // =========================================================================
    let DATA = null;
    let activeCategory = null;

    // Disable datalabels globally — enable per-chart where needed
    Chart.defaults.plugins.datalabels = { display: false };

    async function init() {
        try {
            const resp = await fetch('data/concentration.json');
            DATA = await resp.json();
        } catch (e) {
            document.getElementById('treemapContainer').innerHTML =
                '<div class="flex items-center justify-center h-full text-red-400">Failed to load data/concentration.json</div>';
            return;
        }

        renderMainTreemap();
        renderDoughnutChart();
        renderTop15Chart();
        renderPlatformMixChart();
    }

    // -------------------------------------------------------------------------
    //  MAIN TREEMAP
    // -------------------------------------------------------------------------
    function renderMainTreemap() {
        const container = document.getElementById('treemapContainer');
        activeCategory = null;
        document.getElementById('treemapResetBtn').classList.add('hidden');
        document.getElementById('drillDownPanel').classList.add('hidden');

        renderTreemap(
            container,
            DATA.categories,
            (cell) => getCatColor(cell.name),
            onCategoryClick
        );
    }

    function onCategoryClick(cell, div) {
        // Mark active
        const container = document.getElementById('treemapContainer');
        container.querySelectorAll('.treemap-cell').forEach(el => el.classList.remove('active'));
        div.classList.add('active');

        activeCategory = cell.name;
        document.getElementById('treemapResetBtn').classList.remove('hidden');

        // Find full category data
        const cat = DATA.categories.find(c => c.name === cell.name);
        if (!cat || !cat.children || !cat.children.length) return;

        showDrillDown(cat);
    }

    function shadeColor(hex, index, total) {
        // Create varied shades from the base color for subcategory cells
        const r = parseInt(hex.slice(1, 3), 16);
        const g = parseInt(hex.slice(3, 5), 16);
        const b = parseInt(hex.slice(5, 7), 16);
        const factor = 0.5 + (0.5 * (1 - index / Math.max(total, 1)));
        return {
            bg: `rgb(${Math.round(r * factor)}, ${Math.round(g * factor)}, ${Math.round(b * factor)})`,
            bgDark: `rgb(${Math.round(r * factor * 0.6)}, ${Math.round(g * factor * 0.6)}, ${Math.round(b * factor * 0.6)})`,
            text: '#fff',
        };
    }

    function showDrillDown(cat) {
        const panel = document.getElementById('drillDownPanel');
        panel.classList.remove('hidden');
        panel.classList.add('fade-in');

        const col = getCatColor(cat.name);
        document.getElementById('drillDot').style.background = col.bg;
        document.getElementById('drillTitle').textContent = cat.name;
        document.getElementById('drillPct').textContent = `${cat.pct}% of total volume (${fmtBillions(cat.value)})`;

        // Drill-down treemap with varied shading per subcategory
        const drillContainer = document.getElementById('drillTreemap');
        const topChildren = cat.children.filter(c => c.value > 0).slice(0, 20);
        const total = topChildren.length;

        renderTreemap(
            drillContainer,
            topChildren,
            (cell) => {
                const idx = topChildren.findIndex(c => c.name === cell.name);
                return shadeColor(col.bg, idx, total);
            },
            null
        );

        // Table
        const table = document.getElementById('drillTable');
        table.innerHTML = '';
        cat.children.forEach((child, i) => {
            if (child.value <= 0) return;
            const pctOfCat = ((child.value / cat.value) * 100).toFixed(1);
            const barWidth = Math.max(2, (child.value / cat.children[0].value) * 100);
            const shade = shadeColor(col.bg, i, cat.children.length);
            const row = document.createElement('div');
            row.className = 'flex items-center gap-3';
            row.innerHTML = `
                <span class="text-gray-500 text-xs w-5 text-right shrink-0">${i + 1}</span>
                <div class="flex-1 min-w-0">
                    <div class="flex items-center justify-between mb-0.5">
                        <span class="text-sm text-white truncate">${child.name}</span>
                        <span class="text-xs text-gray-400 ml-2 shrink-0">${pctOfCat}% of cat / ${child.pct}% total</span>
                    </div>
                    <div class="h-2 bg-dark-700 rounded-full overflow-hidden">
                        <div class="h-full rounded-full" style="width:${barWidth}%; background:${shade.bg};"></div>
                    </div>
                </div>
                <span class="text-xs text-gray-400 w-16 text-right shrink-0 font-mono">${fmtBillions(child.value)}</span>
            `;
            table.appendChild(row);
        });

        // Scroll to panel
        panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    // Reset button
    document.getElementById('treemapResetBtn').addEventListener('click', renderMainTreemap);

    // -------------------------------------------------------------------------
    //  DOUGHNUT CHART
    // -------------------------------------------------------------------------
    let doughnutChartInstance = null;

    function renderDoughnutChart() {
        const ctx = document.getElementById('doughnutChart').getContext('2d');
        const labels = DATA.categories.map(c => c.name);
        const values = DATA.categories.map(c => c.value);
        const colors = DATA.categories.map(c => getCatColor(c.name).bg);

        if (doughnutChartInstance) doughnutChartInstance.destroy();

        doughnutChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels,
                datasets: [{
                    data: values,
                    backgroundColor: colors,
                    borderColor: '#0f0f1a',
                    borderWidth: 2,
                    hoverBorderColor: '#fff',
                    hoverBorderWidth: 2,
                }]
            },
            options: {
                responsive: true,
                cutout: '55%',
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: '#9ca3af',
                            padding: 16,
                            usePointStyle: true,
                            pointStyleWidth: 10,
                            font: { size: 12 }
                        }
                    },
                    tooltip: {
                        backgroundColor: '#1a1a2e',
                        titleColor: '#fff',
                        bodyColor: '#d1d5db',
                        borderColor: '#252547',
                        borderWidth: 1,
                        callbacks: {
                            label: function(ctx) {
                                const v = ctx.raw;
                                const pct = ((v / DATA.total) * 100).toFixed(1);
                                return ` ${ctx.label}: ${fmtBillions(v)} (${pct}%)`;
                            }
                        }
                    }
                }
            }
        });
    }

    // -------------------------------------------------------------------------
    //  PLATFORM MIX CHART (Kalshi % by category)
    // -------------------------------------------------------------------------
    let platformMixInstance = null;

    function renderPlatformMixChart() {
        const ctx = document.getElementById('platformMixChart').getContext('2d');
        const labels = DATA.categories.map(c => c.name);
        const kalshiPcts = DATA.categories.map(c => c.kalshi_pct);
        const polyPcts = DATA.categories.map(c => 100 - c.kalshi_pct);
        const colors = DATA.categories.map(c => getCatColor(c.name).bg);

        if (platformMixInstance) platformMixInstance.destroy();

        platformMixInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels,
                datasets: [
                    {
                        label: 'Kalshi',
                        data: kalshiPcts,
                        backgroundColor: '#f59e0b',
                        borderRadius: 0,
                        barPercentage: 0.7,
                        categoryPercentage: 0.8,
                    },
                    {
                        label: 'Polymarket',
                        data: polyPcts,
                        backgroundColor: '#8b5cf6',
                        borderRadius: 0,
                        barPercentage: 0.7,
                        categoryPercentage: 0.8,
                    }
                ]
            },
            plugins: [ChartDataLabels],
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        stacked: true,
                        min: 0,
                        max: 100,
                        grid: { color: 'rgba(255,255,255,0.05)' },
                        ticks: { color: '#6b7280', callback: v => v + '%' }
                    },
                    y: {
                        stacked: true,
                        grid: { display: false },
                        ticks: { color: '#d1d5db', font: { size: 13, weight: 'bold' } }
                    }
                },
                plugins: {
                    datalabels: {
                        display: ctx => ctx.raw >= 10,
                        color: '#fff',
                        font: { size: 12, weight: 'bold' },
                        anchor: 'center',
                        align: 'center',
                        formatter: v => v.toFixed(1) + '%',
                    },
                    legend: {
                        labels: { color: '#9ca3af', usePointStyle: true, pointStyleWidth: 10, font: { size: 12 } }
                    },
                    tooltip: {
                        backgroundColor: '#1a1a2e',
                        titleColor: '#fff',
                        bodyColor: '#d1d5db',
                        borderColor: '#252547',
                        borderWidth: 1,
                        callbacks: {
                            label: ctx => ` ${ctx.dataset.label}: ${ctx.raw.toFixed(1)}%`
                        }
                    }
                }
            }
        });
    }

    // -------------------------------------------------------------------------
    //  TOP 15 SUBCATEGORIES HORIZONTAL BAR CHART
    // -------------------------------------------------------------------------
    let top15Instance = null;

    function renderTop15Chart() {
        const ctx = document.getElementById('top15Chart').getContext('2d');

        // Gather all subcategories with parent info
        const allSubs = [];
        DATA.categories.forEach(cat => {
            (cat.children || []).forEach(child => {
                allSubs.push({
                    name: child.name,
                    value: child.value,
                    pct: child.pct,
                    parent: cat.name
                });
            });
        });

        // Sort and take top 15
        allSubs.sort((a, b) => b.value - a.value);
        const top15 = allSubs.slice(0, 15);

        const labels = top15.map(s => s.name);
        const values = top15.map(s => s.value);
        const colors = top15.map(s => getCatColor(s.parent).bg);

        if (top15Instance) top15Instance.destroy();

        top15Instance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels,
                datasets: [{
                    label: 'Volume',
                    data: values,
                    backgroundColor: colors,
                    borderRadius: 4,
                    barThickness: 24,
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        grid: { color: 'rgba(255,255,255,0.05)' },
                        ticks: {
                            color: '#6b7280',
                            callback: function(v) { return fmtBillions(v); }
                        }
                    },
                    y: {
                        grid: { display: false },
                        ticks: {
                            color: '#d1d5db',
                            font: { size: 11 },
                        }
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: '#1a1a2e',
                        titleColor: '#fff',
                        bodyColor: '#d1d5db',
                        borderColor: '#252547',
                        borderWidth: 1,
                        callbacks: {
                            title: function(items) {
                                const idx = items[0].dataIndex;
                                return `${top15[idx].name} (${top15[idx].parent})`;
                            },
                            label: function(ctx) {
                                const idx = ctx.dataIndex;
                                return ` ${fmtBillions(ctx.raw)} (${top15[idx].pct}% of total)`;
                            }
                        }
                    }
                }
            }
        });
    }

    // -------------------------------------------------------------------------
    //  RESIZE HANDLER
    // -------------------------------------------------------------------------
    let resizeTimer;
    window.addEventListener('resize', () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(() => {
            if (DATA) {
                renderMainTreemap();
                if (activeCategory) {
                    const cat = DATA.categories.find(c => c.name === activeCategory);
                    if (cat) showDrillDown(cat);
                }
            }
        }, 200);
    });

    // -------------------------------------------------------------------------
    //  INIT
    // -------------------------------------------------------------------------
    init();
    </script>
    <script src="i18n.js"></script>
    <script>
    I18N.init({
        'con.title':      '집중도 & 취약성',
        'con.subtitle':   '예측 시장은 압도적으로 <span class="text-green-400 font-semibold">스포츠 베팅</span>입니다. Kalshi와 Polymarket의 전체 거래량 중 절반 이상이 소수의 스포츠 하위 카테고리에 집중됩니다. 이러한 극단적 집중은 취약성을 만듭니다: 스포츠 베팅에 대한 단일 규제 조치가 시장 활동의 대부분을 하루아침에 소멸시킬 수 있습니다.',
        'con.s1':         '전체 거래량 중 스포츠 베팅',
        'con.s1.sub':     '총 $871억 중 $491억',
        'con.s2':         '상위 5개 하위 카테고리가 장악',
        'con.s2.sub':     '풋볼, 농구, 미국 선거, 축구, 비트코인',
        'con.s3':         '풋볼 단독',
        'con.s3.sub':     '$169억 &mdash; 전체 암호화폐보다 큼',
        'con.tree.title': '거래량 트리맵',
        'con.tree.desc':  '카테고리를 클릭하면 하위 카테고리를 볼 수 있습니다',
        'con.tree.back':  '\u2190 개요로 돌아가기',
        'con.donut.title':'카테고리 분석',
        'con.donut.desc': '최상위 카테고리별 전체 거래량 비중',
        'con.mix.title':  '카테고리별 플랫폼 비율',
        'con.mix.desc':   '카테고리별 Kalshi vs Polymarket 거래량 비중',
        'con.top15.title':'상위 15개 하위 카테고리',
        'con.top15.desc': '모든 카테고리를 통틀어 가장 큰 하위 카테고리 (상위 카테고리 색상별)',
        'con.meaning':    '이것이 의미하는 것',
        'con.risk.title': '집중 리스크',
        'con.risk.desc':  '전체 거래량의 절반 이상이 두 가지 스포츠 하위 카테고리(풋볼과 농구)에 집중되어 있습니다. 이 수준의 집중도는 규제 변화, 시즌 비수기, 또는 스포츠 베팅에 대한 대중의 인식 변화에 대한 체계적 리스크를 만듭니다.',
        'con.tail.title': '롱테일은 미미함',
        'con.tail.desc':  '"예측 시장"의 이상적 목적인 경제, 과학, 정책 예측 카테고리는 전체 거래량의 7% 미만을 차지합니다. 정보 집약 도구로서의 예측 시장의 지적 약속은 스포츠와 암호화폐 투기의 현실에 압도되고 있습니다.',
    });
    </script>
</body>
</html>
